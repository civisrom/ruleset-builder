name: Build and Release Rulesets

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # Запуск каждый день в 00:00 UTC для обновления правил
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Create output directory
      run: mkdir -p output
    
    - name: Validate ruleset builder
      run: |
        python ruleset_builder.py --help || echo "CLI validation skipped"
    
    - name: Generate JSON ruleset
      run: |
        # Пример генерации ruleset из файлов в data/
        if [ -d "data" ]; then
          python ruleset_builder.py \
            -o output/ruleset \
            -f json \
            --domain data/domains.txt \
            --domain-suffix data/suffixes.txt \
            --ip-cidr data/ips.txt \
            --validate
        else
          echo "No data directory found, skipping generation"
        fi
    
    - name: Upload JSON artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rulesets-json
        path: output/*.json
        retention-days: 90
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          output/*.json
          output/*.srs
          output/*.mrs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-windows:
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build Windows executable
      run: |
        pyinstaller --onefile --windowed --name RulesetBuilder ruleset_builder.py
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: RulesetBuilder-Windows
        path: dist/RulesetBuilder.exe
        retention-days: 90
  
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        # Создаём тестовый скрипт
        cat > test_basic.py << 'EOF'
        import sys
        sys.path.insert(0, '.')
        from ruleset_builder import FileProcessor, RulesetGenerator
        
        # Тест валидации домена
        assert FileProcessor.validate_domain('example.com') == True
        assert FileProcessor.validate_domain('invalid..com') == False
        
        # Тест валидации IP
        assert FileProcessor.validate_ip_cidr('192.168.1.0/24') == True
        assert FileProcessor.validate_ip_cidr('999.999.999.999') == False
        
        print('✅ All tests passed!')
        EOF
